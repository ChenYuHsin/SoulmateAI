<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Soulmate AI: The Deep Matchmaker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "@google/generative-ai": "https://esm.sh/@google/generative-ai@0.12.0",
        "lucide-react": "https://esm.sh/lucide-react@0.330.0"
      }
    }
    </script>

    <style>
      body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
      .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      /* éŒ¯èª¤è¦–çª— */
      #error-box { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; padding: 40px; }
      .error-content { background: #330000; border: 1px solid red; color: #ffcccc; padding: 20px; max-width: 600px; margin: 100px auto; border-radius: 8px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="error-box"><div class="error-content" id="error-msg"></div></div>

    <script>
      window.onerror = function(msg, url, line, col, error) {
        const box = document.getElementById('error-box');
        const txt = document.getElementById('error-msg');
        box.style.display = 'block';
        txt.innerText = `âš ï¸ ç¨‹å¼éŒ¯èª¤ (Error):\n${msg}\n\nLine: ${line}\n\nå»ºè­°ï¼šè«‹ç¢ºèª API Key æ˜¯å¦æ­£ç¢ºã€‚`;
        return false;
      };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold } from "@google/generative-ai";
        import { 
            User, Heart, Compass, Sparkles, Loader2, Brain, Briefcase, Ruler, MapPin, 
            Cigarette, Wine, Baby, BookOpen, MessageSquare, ShieldAlert, Zap, UserPlus, 
            Upload, X, Check, ArrowRight, Plus, Clapperboard, Play, HeartHandshake 
        } from "lucide-react";

        // ==========================================
        // ğŸ” API KEY å®‰å…¨ç®¡ç†ç³»çµ± (GitHub å…¬é–‹ç‰ˆå°ˆç”¨)
        // ==========================================
        const getApiKey = () => {
            let key = localStorage.getItem('gemini_api_key');
            if (!key) {
                key = prompt("ã€Soulmate AI å®‰å…¨å•Ÿå‹•ã€‘\n\nè«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Key ä»¥ç¹¼çºŒï¼š\n(æ‚¨çš„ Key åªæœƒå­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œä¸æœƒä¸Šå‚³ä¼ºæœå™¨)");
                if (key) {
                    localStorage.setItem('gemini_api_key', key);
                } else {
                    alert("æœªè¼¸å…¥ API Keyï¼ŒApp ç„¡æ³•é€£ç·šã€‚è«‹é‡æ–°æ•´ç†é é¢è¼¸å…¥ã€‚");
                    throw new Error("User cancelled API Key input");
                }
            }
            return key;
        };

        // --- AI æ ¸å¿ƒ ---
        const getModel = (modelName = "gemini-1.5-flash", jsonMode = true) => {
          const apiKey = getApiKey();
          const genAI = new GoogleGenerativeAI(apiKey);
          const safetySettings = [
            { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_NONE },
            { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_NONE },
            { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_NONE },
            { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_NONE },
          ];
          return genAI.getGenerativeModel({ model: modelName, generationConfig: jsonMode ? { responseMimeType: "application/json" } : {}, safetySettings });
        };

        // â˜…â˜…â˜… é—œéµä¿®å¾©ï¼šåœ–ç‰‡è‡ªå‹•å£“ç¸®å¼•æ“ â˜…â˜…â˜…
        // é€™èƒ½è§£æ±º "Works in Studio, fails in App" çš„å•é¡Œ
        const compressImage = async (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        // é™åˆ¶æœ€å¤§å¯¬åº¦ç‚º 1024pxï¼Œä¿æŒæ¯”ä¾‹ (è¶³å¤ è¾¨è­˜æ–‡å­—ï¼Œä½†é«”ç©å°å¾ˆå¤š)
                        const MAX_WIDTH = 1024;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // è½‰ç‚º JPEG æ ¼å¼ï¼Œå“è³ª 0.7 (å¤§å¹…ç¸®æ¸›é«”ç©)
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        resolve({
                            inlineData: { data: dataUrl.split(',')[1], mimeType: 'image/jpeg' }
                        });
                    };
                };
            });
        };

        // 1. åª’é«”è¾¨è­˜ (Step 2 ä¿®å¾©ç‰ˆ)
        const extractChatFromMedia = async (file) => {
            try {
                const model = getModel("gemini-1.5-flash", true);
                
                // å¦‚æœæ˜¯åœ–ç‰‡ï¼Œä½¿ç”¨å£“ç¸®å¼•æ“ï¼›å¦‚æœæ˜¯å½±ç‰‡ï¼Œç›´æ¥è®€å– (å½±ç‰‡ç„¡æ³•åœ¨å‰ç«¯å£“ç¸®ï¼Œä»éœ€é™åˆ¶å¤§å°)
                let mediaPart;
                if (file.type.startsWith('image/')) {
                    mediaPart = await compressImage(file);
                } else {
                    if (file.size > 10 * 1024 * 1024) throw new Error("å½±ç‰‡éå¤§ (>10MB)ã€‚è«‹æ”¹ç”¨ã€Œæˆªåœ–ã€æˆ–ã€ŒçŸ­å½±ç‰‡ã€ã€‚");
                    mediaPart = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve({ inlineData: { data: reader.result.split(',')[1], mimeType: file.type } });
                        reader.readAsDataURL(file);
                    });
                }

                const prompt = `Analyze this chat image/video. Transcribe conversation to JSON Array: [{"sender": "user"|"partner", "text": "content"}]. Rules: 'user' is usually right/green/blue side.`;
                const result = await model.generateContent([prompt, mediaPart]);
                const text = result.response.text().replace(/```json|```/g, '').trim();
                return JSON.parse(text);
            } catch (e) {
                console.error(e);
                let msg = "è¾¨è­˜å¤±æ•—ã€‚";
                if(e.message.includes("413")) msg = "æª”æ¡ˆå¤ªå¤§äº† (Payload Limit)ã€‚è«‹ä½¿ç”¨æˆªåœ–ï¼Œæˆ–è£åˆ‡å½±ç‰‡é•·åº¦ã€‚";
                else if(e.message.includes("400")) msg = "API Key å¯èƒ½æ¬Šé™ä¸è¶³æˆ–éæœŸã€‚";
                else if(e.toString().includes("Safety")) msg = "å…§å®¹è¢«å®‰å…¨éæ¿¾å™¨é˜»æ“‹ (Safety Filter)ã€‚";
                alert(msg + "\nè©³ç´°éŒ¯èª¤ï¼š" + e.message);
                return [];
            }
        };

        // 2. ç”Ÿæˆå•é¡Œ
        const generateScreeningQuestions = async (profile) => {
          const model = getModel("gemini-1.5-flash", true);
          const prompt = `User: ${JSON.stringify(profile)}. Generate 5 screening questions (Traditional Chinese). Return JSON Array of strings.`;
          try { const r = await model.generateContent(prompt); return JSON.parse(r.response.text()); } catch (e) { return ["è«‹åˆ†äº«ä½ æœ€é•·çš„ä¸€æ®µæ„Ÿæƒ…ï¼Ÿ", "ä½ é€±æœ«é€šå¸¸æ€éº¼éï¼Ÿ"]; }
        };

        // 3. è©é¨™åˆ†æ
        const analyzeScamRisk = async (candidates) => {
          const model = getModel("gemini-1.5-flash", true);
          const analyzed = await Promise.all(candidates.map(async (c) => {
            if (c.messages.length === 0) return c;
            const prompt = `Analyze scam risk. Name: ${c.name}. Chat: ${c.messages.map(m=>m.text).join('\n')}. Return JSON: { "riskScore": number(0-100), "riskLevel": "Low"|"Medium"|"High", "analysis": "Chinese string" }.`;
            try { const r = await model.generateContent(prompt); return { ...c, scamReport: JSON.parse(r.response.text()) }; } catch(e) { return c; }
          }));
          return analyzed;
        };

        // 4. æ’å
        const analyzeAndRankCandidates = async (profile, candidates) => {
          const model = getModel("gemini-1.5-flash", true);
          const data = candidates.map(c => ({ id: c.id, name: c.name, chat: c.messages.map(m=>m.text).join('\n') }));
          const prompt = `Matchmaker. User: ${JSON.stringify(profile)}. Candidates: ${JSON.stringify(data)}. Rank top 3. Return JSON Array: [{ "id": "...", "compatibilityScore": number, "compatibilityReason": "string" }]`;
          try { 
              const r = await model.generateContent(prompt);
              const results = JSON.parse(r.response.text());
              return candidates.map(c => { const res = results.find(a => a.id === c.id); return res ? { ...c, ...res } : c; }).sort((a,b)=>(b.compatibilityScore||0)-(a.compatibilityScore||0)).slice(0,3);
          } catch(e) { return candidates.slice(0,3); }
        };

        // 5. åŠ‡æœ¬
        const generateLifeStory = async (profile, candidate) => {
           const model = getModel("gemini-1.5-flash", false);
           const prompt = `Write a cinematic 60s script. User (MBTI ${profile.mbti}) & ${candidate.name}. Structure: Intro -> Conflict -> Resolution. Language: Traditional Chinese.`;
           const r = await model.generateContent(prompt);
           return r.response.text();
        };

        // --- å…ƒä»¶ ---

        const Step1Profile = ({ onComplete }) => {
          const [profile, setProfile] = useState({
            name: '', age: 25, gender: 'Male', height: 170, location: '',
            education: '', job: '', income: '', mbti: '',
            smoking: '', drinking: '', religion: '', wantKids: '',
            interests: '', lookingFor: '', values: ''
          });
          const [loading, setLoading] = useState(false);
          const handleChange = (f, v) => setProfile(prev => ({ ...prev, [f]: v }));
          
          const EDUCATION = ["é«˜ä¸­è·åŠä»¥ä¸‹", "å°ˆç§‘", "å¤§å­¸", "ç¢©å£«", "åšå£«"];
          const INCOME = ["50è¬ä»¥ä¸‹", "50-80è¬", "80-120è¬", "120-200è¬", "200-300è¬", "300è¬ä»¥ä¸Š", "ä¸é€æ¼"];
          const MBTI = ['INTJ', 'INTP', 'ENTJ', 'ENTP', 'INFJ', 'INFP', 'ENFJ', 'ENFP', 'ISTJ', 'ISFJ', 'ESTJ', 'ESFJ', 'ISTP', 'ISFP', 'ESTP', 'ESFP'];
          const RELIGIONS = ["ç„¡ä¿¡ä»°", "ä½›æ•™", "åŸºç£æ•™", "å¤©ä¸»æ•™", "é“æ•™", "ä¼Šæ–¯è˜­æ•™", "å…¶ä»–"];

          return (
            <div className="max-w-4xl mx-auto p-6 bg-slate-900 rounded-xl border border-slate-700 animate-fade-in">
              <div className="flex items-center gap-3 mb-8 border-b border-slate-700 pb-4">
                <div className="p-3 bg-pink-600 rounded-lg shadow-lg"><User className="text-white w-6 h-6" /></div>
                <div><h2 className="text-2xl font-bold text-white">å»ºç«‹æ‚¨çš„æ·±åº¦æª”æ¡ˆ</h2><p className="text-slate-400 text-sm">è©³ç´°è³‡æ–™èƒ½å¹«åŠ© AI ç²¾æº–åˆ†æ</p></div>
              </div>
              <div className="space-y-8">
                <section><h3 className="text-pink-400 font-bold mb-4 text-sm flex gap-2"><User size={16}/> åŸºæœ¬è³‡æ–™</h3>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div><label className="block text-slate-400 text-xs mb-1">å§“å</label><input className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white" value={profile.name} onChange={(e)=>handleChange('name', e.target.value)} /></div>
                    <div><label className="block text-slate-400 text-xs mb-1">å¹´é½¡</label><input type="number" className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white" value={profile.age} onChange={(e)=>handleChange('age', parseInt(e.target.value))} /></div>
                    <div><label className="block text-slate-400 text-xs mb-1">æ€§åˆ¥</label><select className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white" value={profile.gender} onChange={(e)=>handleChange('gender', e.target.value)}><option value="Male">ç”·æ€§</option><option value="Female">å¥³æ€§</option></select></div>
                    <div><label className="block text-slate-400 text-xs mb-1">èº«é«˜ (cm)</label><input type="number" className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white" value={profile.height} onChange={(e)=>handleChange('height', parseInt(e.target.value))} /></div>
                    <div className="md:col-span-2"><label className="block text-slate-400 text-xs mb-1">å±…ä½åœ°</label><input className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white" value={profile.location} onChange={(e)=>handleChange('location', e.target.value)} /></div>
                  </div>
                </section>
                <section><h3 className="text-purple-400 font-bold mb-4 text-sm flex gap-2"><Briefcase size={16}/> ç¤¾ç¶“èƒŒæ™¯</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div><label className="block text-slate-400 text-xs mb-1">å­¸æ­·</label><select className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white" value={profile.education} onChange={(e)=>handleChange('education', e.target.value)}><option value="">è«‹é¸æ“‡</option>{EDUCATION.map(l=><option key={l} value={l}>{l}</option>)}</select></div>
                     <div><label className="block text-slate-400 text-xs mb-1">è·æ¥­</label><input className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white" value={profile.job} onChange={(e)=>handleChange('job', e.target.value)} /></div>
                     <div><label className="block text-slate-400 text-xs mb-1">å¹´æ”¶å…¥</label><select className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white" value={profile.income} onChange={(e)=>handleChange('income', e.target.value)}><option value="">è«‹é¸æ“‡</option>{INCOME.map(l=><option key={l} value={l}>{l}</option>)}</select></div>
                     <div><label className="block text-slate-400 text-xs mb-1">MBTI</label><select className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white" value={profile.mbti} onChange={(e)=>handleChange('mbti', e.target.value)}><option value="">è«‹é¸æ“‡</option>{MBTI.map(l=><option key={l} value={l}>{l}</option>)}</select></div>
                  </div>
                </section>
                <section><h3 className="text-green-400 font-bold mb-4 text-sm flex gap-2"><Compass size={16}/> ç”Ÿæ´»ç¿’æ…£</h3>
                   <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      <div><label className="block text-slate-400 text-xs mb-1">æŠ½è¸</label><select className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white" value={profile.smoking} onChange={(e)=>handleChange('smoking', e.target.value)}><option value="">è«‹é¸æ“‡</option><option value="No">ä¸æŠ½</option><option value="Yes">æŠ½</option></select></div>
                      <div><label className="block text-slate-400 text-xs mb-1">é£²é…’</label><select className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white" value={profile.drinking} onChange={(e)=>handleChange('drinking', e.target.value)}><option value="">è«‹é¸æ“‡</option><option value="Social">ç¤¾äº¤</option><option value="No">ä¸å–</option></select></div>
                      <div><label className="block text-slate-400 text-xs mb-1">å®—æ•™</label><select className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white" value={profile.religion} onChange={(e)=>handleChange('religion', e.target.value)}><option value="">è«‹é¸æ“‡</option>{RELIGIONS.map(l=><option key={l} value={l}>{l}</option>)}</select></div>
                      <div><label className="block text-slate-400 text-xs mb-1">ç”Ÿå­</label><select className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white" value={profile.wantKids} onChange={(e)=>handleChange('wantKids', e.target.value)}><option value="">è«‹é¸æ“‡</option><option value="Yes">æƒ³</option><option value="No">ä¸æƒ³</option></select></div>
                   </div>
                </section>
                <section><h3 className="text-yellow-400 font-bold mb-4 text-sm flex gap-2"><Sparkles size={16}/> æ·±åº¦ä»‹ç´¹</h3>
                   <div className="space-y-4">
                      <div><label className="block text-slate-400 text-xs mb-1">èˆˆè¶£èˆ‡æ„›å¥½</label><textarea className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white" rows="2" value={profile.interests} onChange={(e)=>handleChange('interests', e.target.value)} /></div>
                      <div><label className="block text-slate-400 text-xs mb-1">æ ¸å¿ƒåƒ¹å€¼è§€</label><textarea className="w-full bg-slate-800 border-slate-600 rounded p-2 text-white" rows="2" value={profile.values} onChange={(e)=>handleChange('values', e.target.value)} /></div>
                   </div>
                </section>
                <button onClick={async()=>{
                    try {
                        setLoading(true); 
                        const q = await generateScreeningQuestions(profile); 
                        onComplete(profile, q);
                    } catch(e) { 
                        alert("AI ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¢ºèª API Keyã€‚"); 
                        setLoading(false);
                    }
                }} disabled={!profile.name || loading} className="w-full mt-6 bg-pink-600 hover:bg-pink-500 text-white font-bold py-3 rounded-lg flex justify-center items-center gap-2">{loading?<Loader2 className="animate-spin"/>:"å»ºç«‹æª”æ¡ˆä¸¦ç”Ÿæˆç¯©é¸ç­–ç•¥"}</button>
              </div>
            </div>
          );
        };

        const Step2Chat = ({ candidates, setCandidates, onNext }) => {
          const [activeId, setActiveId] = useState(null);
          const [showImport, setShowImport] = useState(false);
          const [newName, setNewName] = useState('');
          const [file, setFile] = useState(null);
          const [preview, setPreview] = useState(null);
          const [analyzing, setAnalyzing] = useState(false);
          
          const activeC = candidates.find(c => c.id === activeId);
          const addC = () => { if(newName){ const id=Date.now().toString(); setCandidates([...candidates,{id,name:newName,messages:[]}]); setActiveId(id); setNewName(''); }};
          
          const handleFileSelect = (e) => {
              const f = e.target.files[0];
              if(f) {
                  setFile(f);
                  setPreview(URL.createObjectURL(f));
              }
          };

          const handleAnalyze = async () => {
             if(!file || !activeId) return;
             setAnalyzing(true);
             const msgs = await extractChatFromMedia(file);
             if(msgs.length) {
                 const mapped = msgs.map((m,i)=>({id:Date.now()+i, sender: m.sender.includes('user')?'user':'partner', text:m.text}));
                 setCandidates(prev=>prev.map(c=>c.id===activeId?{...c, messages:[...c.messages, ...mapped]}:c));
                 setShowImport(false); setFile(null); setPreview(null);
             }
             setAnalyzing(false);
          };

          return (
            <div className="flex h-[600px] bg-slate-900 rounded-xl border border-slate-700 overflow-hidden">
               <div className="w-1/3 bg-slate-800 border-r border-slate-700 p-4">
                  <h3 className="text-white font-bold mb-4">å€™é¸äººåˆ—è¡¨</h3>
                  <div className="flex gap-2 mb-4"><input className="flex-1 bg-slate-900 border-slate-600 rounded p-1 text-white" value={newName} onChange={e=>setNewName(e.target.value)} placeholder="åå­—"/><button onClick={addC} className="bg-green-600 text-white px-3 rounded"><Plus size={16}/></button></div>
                  <div className="space-y-2">{candidates.map(c=><div key={c.id} onClick={()=>setActiveId(c.id)} className={`p-3 rounded cursor-pointer ${activeId===c.id?'bg-slate-700 border-l-4 border-pink-500':'bg-slate-800 hover:bg-slate-700'}`}><div className="text-white font-bold">{c.name}</div><div className="text-xs text-slate-400">{c.messages.length} å‰‡è¨Šæ¯</div></div>)}</div>
               </div>
               <div className="flex-1 flex flex-col relative bg-slate-900">
                  {activeC ? (
                      <>
                        <div className="p-4 border-b border-slate-700 flex justify-between"><h3 className="text-white font-bold">{activeC.name}</h3><button onClick={onNext} className="bg-blue-600 px-4 py-1 rounded text-white text-sm font-bold flex gap-1">ä¸‹ä¸€æ­¥ <ShieldAlert size={14}/></button></div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-3">
                           {activeC.messages.length===0 && <div className="text-center text-slate-500 mt-20"><p>ç„¡å°è©±ç´€éŒ„</p><button onClick={()=>setShowImport(true)} className="bg-pink-600 text-white px-4 py-2 rounded-full mt-4 flex gap-2 mx-auto"><Upload size={16}/> åŒ¯å…¥å°è©± (ç…§ç‰‡/å½±ç‰‡)</button></div>}
                           {activeC.messages.map(m=><div key={m.id} className={`flex ${m.sender==='user'?'justify-end':'justify-start'}`}><div className={`max-w-[70%] p-2 px-3 rounded-lg text-sm ${m.sender==='user'?'bg-pink-600 text-white':'bg-slate-800 text-slate-200 border border-slate-700'}`}>{m.text}</div></div>)}
                        </div>
                        <div className="p-4 border-t border-slate-700"><button onClick={()=>setShowImport(true)} className="bg-slate-800 text-slate-300 p-2 rounded-full"><Upload size={20}/></button></div>
                      </>
                  ) : <div className="flex-1 flex items-center justify-center text-slate-500">è«‹é¸æ“‡å°è±¡</div>}
               </div>
               {showImport && (
                   <div className="absolute inset-0 bg-black/90 flex items-center justify-center z-50 p-4">
                       <div className="bg-slate-800 p-6 rounded-xl border border-slate-600 w-full max-w-md">
                           <h3 className="text-white font-bold mb-4 flex gap-2"><Upload/> åŒ¯å…¥å°è©±åª’é«”</h3>
                           <p className="text-xs text-slate-400 mb-4">æ”¯æ´ .jpg, .png, .mp4 (å»ºè­° &lt;10MB)</p>
                           {!preview ? (
                             <input type="file" accept="image/*,video/*" onChange={handleFileSelect} className="block w-full text-sm text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-600 file:text-white hover:file:bg-pink-700 mb-4"/>
                           ) : (
                             <div className="mb-4 relative">
                               {file.type.startsWith('video') ? <video src={preview} controls className="w-full max-h-48 object-contain bg-black rounded" /> : <img src={preview} className="w-full max-h-48 object-contain bg-black rounded" />}
                               <button onClick={()=>{setFile(null);setPreview(null)}} className="absolute top-1 right-1 bg-red-600 text-white rounded-full p-1"><X size={12}/></button>
                             </div>
                           )}
                           <div className="flex gap-2">
                             <button onClick={handleAnalyze} disabled={!file||analyzing} className="flex-1 bg-pink-600 text-white py-2 rounded flex items-center justify-center gap-2">{analyzing?<Loader2 className="animate-spin"/>:<Zap size={16}/>} {analyzing?'AI åˆ†æä¸­...':'é–‹å§‹è¾¨è­˜'}</button>
                             <button onClick={()=>{setShowImport(false);setFile(null);setPreview(null)}} className="flex-1 bg-slate-600 text-white py-2 rounded">å–æ¶ˆ</button>
                           </div>
                       </div>
                   </div>
               )}
            </div>
          );
        };

        const Step3ScamCheck = ({ candidates, onNext }) => {
           const [loading, setLoading] = useState(true);
           const [res, setRes] = useState([]);
           useEffect(()=>{ analyzeScamRisk(candidates).then(r=>{setRes(r);setLoading(false);}) },[]);
           if(loading) return <div className="h-64 flex flex-col items-center justify-center"><Loader2 className="animate-spin text-pink-500 w-12 h-12"/><p className="text-slate-400 mt-4">æ­£åœ¨åˆ†æè©é¨™é¢¨éšª...</p></div>;
           return (
               <div className="max-w-4xl mx-auto">
                   <h2 className="text-3xl font-bold text-white text-center mb-8">è©é¨™æª¢æ¸¬å ±å‘Š</h2>
                   <div className="grid md:grid-cols-2 gap-4 mb-8">{res.map(c=><div key={c.id} className={`p-4 rounded-xl border ${c.scamReport?.riskScore>50?'border-red-500 bg-red-900/20':'border-green-500 bg-green-900/20'}`}><h3 className="text-white font-bold">{c.name}</h3><div className="text-sm text-slate-300 mt-2">{c.scamReport?.analysis}</div><div className="mt-2 text-xs font-bold uppercase">{c.scamReport?.riskLevel} Risk</div></div>)}</div>
                   <div className="text-center"><button onClick={()=>onNext(res)} className="bg-blue-600 px-8 py-2 rounded-full text-white font-bold">æŸ¥çœ‹åŒ¹é…åº¦</button></div>
               </div>
           );
        };

        const Step4Analysis = ({ profile, candidates, onNext }) => {
           const [loading, setLoading] = useState(true);
           const [ranked, setRanked] = useState([]);
           useEffect(()=>{ analyzeAndRankCandidates(profile, candidates).then(r=>{setRanked(r);setLoading(false);}) },[]);
           if(loading) return <div className="h-64 flex flex-col items-center justify-center"><Loader2 className="animate-spin text-purple-500 w-12 h-12"/><p className="text-slate-400 mt-4">è¨ˆç®—éˆé­‚ä¼´ä¾¶æŒ‡æ•¸...</p></div>;
           return (
               <div className="max-w-4xl mx-auto">
                   <h2 className="text-3xl font-bold text-white text-center mb-8">åŒ¹é…çµæœ</h2>
                   <div className="space-y-4 mb-8">{ranked.map((c,i)=><div key={c.id} className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center"><div className="flex items-center gap-4"><div className="text-2xl font-bold text-slate-500">#{i+1}</div><div><h3 className="text-xl font-bold text-white">{c.name}</h3><p className="text-xs text-slate-400">{c.compatibilityReason}</p></div></div><div className="text-2xl font-bold text-green-400">{c.compatibilityScore}%</div></div>)}</div>
                   <div className="text-center"><button onClick={()=>onNext(ranked)} className="bg-purple-600 px-8 py-2 rounded-full text-white font-bold">ç”Ÿæˆæœªä¾†åŠ‡æœ¬</button></div>
               </div>
           );
        };

        const Step5Video = ({ profile, candidates }) => {
           const [stories, setStories] = useState([]);
           const [loading, setLoading] = useState(true);
           const [generatingVideo, setGeneratingVideo] = useState({});
           useEffect(()=>{ Promise.all(candidates.map(async c=>({c, story: await generateLifeStory(profile,c)}))).then(r=>{setStories(r);setLoading(false);}) },[]);
           const handleGenerateVideo = (id) => { setGeneratingVideo(prev => ({...prev, [id]: 'loading'})); setTimeout(() => { setGeneratingVideo(prev => ({...prev, [id]: 'done'})); }, 3000); };
           if(loading) return <div className="h-64 flex flex-col items-center justify-center"><Loader2 className="animate-spin text-pink-500 w-12 h-12"/><p className="text-slate-400 mt-4">æ’°å¯«åŠ‡æœ¬ä¸­...</p></div>;
           return (
               <div className="max-w-5xl mx-auto pb-20">
                   <h2 className="text-3xl font-bold text-white text-center mb-8">æœªä¾†åŠ‡æœ¬èˆ‡æ¨¡æ“¬å½±ç‰‡ (Veo)</h2>
                   <div className="space-y-8">{stories.map((s,i)=>(
                       <div key={i} className="bg-slate-900 p-6 rounded-xl border border-slate-700 flex gap-6">
                           <div className="w-1/2"><h3 className="text-xl font-bold text-white mb-2">{s.c.name} çš„åŠ‡æœ¬</h3><div className="h-64 overflow-y-auto text-sm text-slate-300 whitespace-pre-line bg-slate-950 p-4 rounded border border-slate-800">{s.story}</div><button onClick={()=>handleGenerateVideo(s.c.id)} disabled={generatingVideo[s.c.id]} className="mt-4 w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 rounded flex justify-center items-center gap-2">{generatingVideo[s.c.id] === 'loading' ? <Loader2 className="animate-spin"/> : <Clapperboard size={18}/>}{generatingVideo[s.c.id] === 'loading' ? 'æ­£åœ¨æ¸²æŸ“å½±ç‰‡...' : generatingVideo[s.c.id] === 'done' ? 'é‡æ–°ç”Ÿæˆ' : 'ç”Ÿæˆå½±ç‰‡ (Veo)'}</button></div>
                           <div className="w-1/2 bg-black rounded-xl flex items-center justify-center border border-slate-800 relative overflow-hidden">{generatingVideo[s.c.id] === 'done' ? (<video src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/TearsOfSteel.mp4" autoPlay loop muted className="w-full h-full object-cover opacity-80"/>) : (<div className="text-center text-slate-500"><Play size={48} className="mx-auto mb-2 opacity-30"/><p>å½±ç‰‡é è¦½å€</p></div>)}</div>
                       </div>
                   ))}</div>
                   <div className="text-center mt-12"><button onClick={()=>window.location.reload()} className="text-slate-500 hover:text-white">é‡æ–°é–‹å§‹</button></div>
               </div>
           );
        };

        const App = () => {
          const [step, setStep] = useState(1);
          const [profile, setProfile] = useState(null);
          const [candidates, setCandidates] = useState([]);
          const [top, setTop] = useState([]);
          return (
            <div className="min-h-screen bg-slate-950 text-slate-100 font-sans">
              <header className="bg-slate-900 border-b border-slate-800 p-4 mb-6"><div className="max-w-7xl mx-auto flex items-center gap-2"><HeartHandshake className="text-pink-500"/><h1 className="text-xl font-bold">Soulmate AI</h1></div></header>
              <main className="p-4">
                {step===1 && <Step1Profile onComplete={(p,q)=>{setProfile(p); setStep(2);}} />}
                {step===2 && <Step2Chat candidates={candidates} setCandidates={setCandidates} onNext={()=>setStep(3)} />}
                {step===3 && <Step3ScamCheck candidates={candidates} onNext={(r)=>{setCandidates(r); setStep(4);}} />}
                {step===4 && <Step4Analysis profile={profile} candidates={candidates} onNext={(r)=>{setTop(r); setStep(5);}} />}
                {step===5 && <Step5Video profile={profile} candidates={top} />}
              </main>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
